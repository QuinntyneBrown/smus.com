<!doctype html>
<head>
  <title>Screen video capture for Chrome OS | Boris Smus</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="


This post is about video capture in Chrome that doesn't rely on any
external dependencies like Flash (no fun), NPAPI (not supported on
Chrome OS) and Native Client (not *yet* supported on Chrome OS).">

  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="/static/icons/favicon.ico" />
  <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">

  <!-- Styles -->
  <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:700|PT+Sans|Inconsolata' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/static/stylesheets/screen.css" type="text/css" media="screen" charset="utf-8">

  <!-- Feed -->
  <link href="http://feeds.feedburner.com/smuscom" rel="alternate" title="Boris Smus" type="application/atom+xml"/>
</head>
<body>
  <header>
    <span class="left">
      <a href="/" class="name">Boris Smus</a>
    </span>
    <span class="right">
      <a href="/projects/">Projects</a>
      <a href="/about/">About</a>
      <a href="/archive/posts/">Archives</a>
    </span>
  </header>

  <div id="main">
    <section id="articles">
      
<article>
  <h1><a href="/screen-capture-for-chrome-os">Screen video capture for Chrome OS</a></h1>
  <div class="subtitle">
  
  <time>Published on 04 October 2011</time>
  
  
  </div>
  <p>
    <p>This post is about video capture in Chrome that doesn't rely on any
external dependencies like Flash (no fun), NPAPI (not supported on
Chrome OS) and Native Client (not <em>yet</em> supported on Chrome OS).</p>

<p>I take screenshots all the time for bug reporting, image editing, etc.
On OS X, this functionality is conveniently built in, and available
through <code>Command</code> - <code>Shift</code> - <code>4</code>. As a web denizen, I find it very
useful to auto-upload these captures to a remote server, so I wrote this
<a href="https://github.com/borismus/screencapture-www">minimal image uploader</a> which replaces the default behavior
on OS X to capture the screenshot, and also uploads it to a picture
hosting service.</p>

<p>Taking video capture of various UIs is also immensely useful for showing
demonstrations, complex interactions, and subtle bugs. I recently
re-discovered that QuickTime on OS X comes with this functionality built
in. Prior to that I used (paid) ScreenFlow, which also has very nice
dimension cropping and time dilation features.</p>

<p>What if we're on a web-only device, such as a Chromebook running Chrome
OS? There is a still screenshotting API, but capturing video is less
trivial. I've released an extension that captures and play backs video
captures inside Chrome, and also lets you share stills to Picasa (using
the OAuth 2 <a href="http://smus.com/oauth2-chrome-extensions">extension library</a>). It's available on the
<a href="https://chrome.google.com/webstore/detail/omahgjnmfgeeeoekegajhndkncocoofd">webstore</a>, and the source is on <a href="https://github.com/borismus/chrome-screencast">github</a>. Read on to
learn how it works, and see how you can help.</p>

<h1>Screenshots in Chrome</h1>

<p>Chrome provides the <a href="http://code.google.com/chrome/extensions/tabs.html#method-captureVisibleTab"><code>captureVisibleTab</code></a> extension API for taking
a screenshot of a tab. It requires host permissions on the page, but as
usual the <all_urls> permission will enable the API across all pages
(with some exceptions). A few successful extensions, such as
<a href="http://awesomescreenshot.com/">Awesome Screenshot</a>, use this API and allow
cropping, annotation and sharing of screen grabs.</p>

<p>What if you want to capture video of a tab? Chrome provides no
pre-existing API for this purpose, however, we can piggyback on the
still screenshot API, executing it repeatedly from the background page
for every frame we want to capture:</p>

<pre><code>var images = [];
var FPS = 30;
var QUALITY = 50;
timer = setInterval(function() {
  chrome.tabs.captureVisibleTab(null, {quality: QUALITY},
    function(img) {
      images.push(img);
    });
}, 1000 / FPS);
</code></pre>

<p>As we capture, we store the base64-encoded strings representing video
frames in an array. Once we're done capturing, we can simulate video
playback by rapidly swapping the images in and out:</p>

<pre><code>var background = chrome.extension.getBackgroundPage();
timer = setInterval(function() {
  if (currentIndex &gt;= images.length - 1) {
    pause();
    return;
  }
  setIndex(currentIndex + 1);
  updateSliderPosition();
}, 1000 / background.FPS);
</code></pre>

<p>This approach turns out to be surprisingly efficient, with the extension
being able to capture at 30 FPS on a MacBook Air, and 10 FPS on a
Chromebook without too much noticeable slowdown.</p>

<p>Note that we rely on a fixed FPS for ease of implementation, however one
could imagine using <code>requestAnimationFrame</code> and tracking the variable
frame rate so that the playback speed is reasonable. However, there are
definitely precision issues with JavaScript's timers, so this is a much
more challenging approach.</p>

<p>So we can capture and playback videos inside the browser, but getting it
out of the browser is another matter entirely. As a temporary measure,
my colleague <a href="http://greenido.wordpress.com">Ido Green</a> built a screen stitching service which
encodes multiple images into a movie using ffmpeg. Ideally, of course,
we would encode in the browser. Perhaps a JavaScript video encoder could
be implemented, though the performance may be too poor for practical
use. Alternatively, a ffmpeg Native Client-based approach might be
suitable, especially given that ffmpeg has <a href="http://code.google.com/p/naclports/source/browse/trunk/src/libraries/ffmpeg-0.5/">already been ported</a>.</p>

<h1>Free ideas</h1>

<p>There are a few logical next steps for this sample. As already
mentioned, encoding video in the browser is a top priority, but there
are a slew of other interesting directions, some of which can be seen as
features, and others as separate products.</p>

<ul>
<li><p>The <code>captureVisibleTab</code> API doesn't track the mouse cursor. This could
be done by injecting an overlay onto the current page and tracking
mousemove and click events. This data could then either be drawn onto
a canvas context, or encoded separately as <code>mouseData</code>, and then drawn
with JavaScript at playback time.</p></li>
<li><p>Cropping the video dimensions, modifying the video time schedule
(speedup, slowdown, truncation) and annotation are all desired
video-editing class features that could be implemented by treating
images as canvases.</p></li>
<li><p>A compelling use case for this technology is creating screen sharing
sessions for demos and presentations. Thus, it would be very useful to
stream the video to a server, and broadcast it to multiple clients in
real time. <a href="http://updates.html5rocks.com/2011/08/What-s-different-in-the-new-WebSocket-protocol">Binary websockets</a> are now available in Chrome,
and this could be a great application.</p></li>
<li><p>Audio annotations on screen captures make perfect sense, and are
widely supported by desktop applications. APIs for sound capture have
been a <a href="http://www.w3.org/2009/dap/">long time coming</a>, but finally we may have an answer
via the <a href="http://www.webrtc.org/">WebRTC</a> ecosystem, and the <code>getUserMedia</code> call.</p></li>
</ul>

<p>By the way, I've switched to exclusively using Markdown for all of my
published writing, and wrote an <a href="https://github.com/borismus/markdown-preview">markdown preview</a> for Chrome
to make my life a bit easier.</p>

  </p>

  <!--
  DISABLED COMMENTS.

  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'smus'; // Required - Replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
  -->
</article>

    </section>
    <aside>
      <img src="/static/images/me.jpg" alt="Headshot of Author" title="Headshot of Author">
      <p>
        I'm Boris Smus, a software engineer and UI prototyper from
        Vancouver, Canada. I currently live in San Francisco and work on
        Chrome related things.
        <a href="/about/" class="readmore"></a>
      </p>
    </aside>
  </div>

  <div id="push"></div>

  <footer>
    <p>
      &copy; 2008 - 2015 Boris Smus<br>
      Powered by <a href="/site/">Lightning</a>
    </p>

    <ul id="social-links">
      <a href="http://feeds.feedburner.com/smuscom" class="social rss" title="RSS" rel="external me">RSS</a>
      <a href="https://github.com/borismus" class="social github" title="GitHub" rel="external me">GitHub</a>
      <a href="https://profiles.google.com/boris.smus" rel="author" class="social plus" title="Google Plus" rel="external me">Google Plus</a>
      <a href="https://twitter.com/borismus" class="social twitter" title="Twitter" rel="external me">Twitter</a>
    </ul>
  </footer>


  <script src="/static/javascripts/highlight.pack.js"></script>
  <script>
    // Syntax highlighting for code.
    hljs.tabReplace = '  ';
    hljs.initHighlightingOnLoad();
  </script>
  <script>
    // Google Analytics.
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-17930798-22', 'smus.com');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>
  <script src="//cdn.webglstats.com/stat.js" defer="defer" async="async"></script>
  <script src="/lightning_error.js"></script>
</body>