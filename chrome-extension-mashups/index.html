<!doctype html>
<head>
  <title>Chrome Extension for thesixtyone | Boris Smus</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="

It's a little late to join the Chrome Extension writing party, and
unfortunately [still too early][] for the Chrome Web Store launch.">

  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="/static/icons/favicon.ico" />
  <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">

  <!-- Styles -->
  <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:700|PT+Sans|Inconsolata' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/static/stylesheets/screen.css" type="text/css" media="screen" charset="utf-8">

  <!-- Feed -->
  <link href="http://feeds.feedburner.com/smuscom" rel="alternate" title="Boris Smus" type="application/atom+xml"/>
</head>
<body>
  <header>
    <span class="left">
      <a href="/" class="name">Boris Smus</a>
    </span>
    <span class="right">
      <a href="/projects/">Projects</a>
      <a href="/about/">About</a>
      <a href="/archive/posts/">Archives</a>
    </span>
  </header>

  <div id="main">
    <section id="articles">
      
<article>
  <h1><a href="/chrome-extension-mashups">Chrome Extension for thesixtyone</a></h1>
  <div class="subtitle">
  
  <time>Published on 31 October 2010</time>
  
  
  </div>
  <p>
    <p>It's a little late to join the Chrome Extension writing party, and
unfortunately <a href="http://www.readwriteweb.com/archives/chrome_web_store_delayed_until_december.php">still too early</a> for the Chrome Web Store launch.
Timing issues aside, <a href="https://chrome.google.com/extensions/detail/hghoinoackbjefgfkbgnkjknmneajoof">here's an extension</a> that presents
thesixtyone.com in a smaller, simpler interface, effectively saving a
tab in Chrome and removing all of the (useless to me) social game
mechanics from thesixtyone. This post walks through some technical
details of the implementation, message passing between pages of an
extension, JavaScript injection and DOM event generation. </p>

<p>Wrapping a web application in an extension may sound deceptively easy:
just load the website in an iframe in the background (via 
<a href="https://code.google.com/chrome/extensions/background_pages.html">background pages</a>), and then control the website from the background page
via commands from the popup page that appears when you click the extension icon
in the toolbar. Not so fast! The key issue with this approach is the control
part. For good reason, browser security disallows executing JavaScript in an
embedded iframe if the src is another domain. The solution to this problem is
two fold:</p>

<ol>
<li>Chrome extensions can <a href="https://code.google.com/chrome/extensions/content_scripts.html">inject custom javascript</a> into web pages.</li>
<li>It's possible to <a href="https://code.google.com/chrome/extensions/messaging.html">pass messages</a> between multiple pages running in
Chrome. This is an implementation of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/comms.html">HTML5 postMessage</a>.</li>
</ol>

<p>With these two tools, we can inject javascript that implements a message
listener into a target page. This lets you define a JavaScript API
around the target page. In my case, the API around thesixtyone.com was
the following set of simple commands: next, previous, play, pause and
getSongInfo. Once we have injected JavaScript running in
thesixtyone.com, however, it's impossible to call the site's native
JavaScript for security reasons 
(from <a href="http://code.google.com/chrome/extensions/content_scripts.html">Chrome Extension Developer Guide</a>):</p>

<blockquote>
  <p>Content scripts execute in a special environment called an isolated
  world. They have access to the DOM of the page they are injected into,
  but not to any JavaScript variables or functions created by the page.</p>
</blockquote>

<p>Thus, I had to resort to some unfortunate hackery: generating fake mouse
clicks. One of the benefits of Chrome Extension writing is that there's
no cross-browser issues to deal with, which makes this sort of trick
much more reliable:</p>

<pre><code>function simulateClick(elementId) {
  var clickEvent = document.createEvent('MouseEvents');
  clickEvent.initMouseEvent('click', true, false,  document,
      0, 0, 0, 0, 0, false, false, false, false, 0, null);
  document.getElementById(elementId).dispatchEvent(clickEvent);
}
</code></pre>

<p>Overall, the interaction between the popup, background and injected code
is rather complex and looks something like this: </p>

<p><img src="chrome-extension-diagram.png" alt="image" /></p>

<p>One Chrome issue came up in the course of development: when you change
an iframe's src attribute such that the only difference compared to the
old one is the hash part of the URL, the iframe src page does not
refresh. I haven't had the chance to test test this on other browsers
yet.</p>

<p>Strictly speaking, what I described isn't really a mashup, since I only
use one source. However, this approach is scalable to multiple sources,
and could easily be used to mash multiple web applications up inside an
extension. I hope this post is useful for people trying to wrap one or
many cross-domain websites in their extension. </p>

<p><img src="radio-61-screenshot.png" alt="image" /> </p>

<p>I added a sprinkle of design and out came a Chrome Extension called
Radio 61! Let me know what you think if you try it out. Source code is
available on <a href="https://github.com/borismus/Radio-61">my github</a>.</p>

  </p>

  <!--
  DISABLED COMMENTS.

  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'smus'; // Required - Replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
  -->
</article>

    </section>
    <aside>
      <img src="/static/images/me.jpg" alt="Headshot of Author" title="Headshot of Author">
      <p>
        I'm Boris Smus, a software engineer and UI prototyper from
        Vancouver, Canada. I currently live in San Francisco and work on
        Chrome related things.
        <a href="/about/" class="readmore"></a>
      </p>
    </aside>
  </div>

  <div id="push"></div>

  <footer>
    <p>
      &copy; 2008 - 2015 Boris Smus<br>
      Powered by <a href="/site/">Lightning</a>
    </p>

    <ul id="social-links">
      <a href="http://feeds.feedburner.com/smuscom" class="social rss" title="RSS" rel="external me">RSS</a>
      <a href="https://github.com/borismus" class="social github" title="GitHub" rel="external me">GitHub</a>
      <a href="https://profiles.google.com/boris.smus" rel="author" class="social plus" title="Google Plus" rel="external me">Google Plus</a>
      <a href="https://twitter.com/borismus" class="social twitter" title="Twitter" rel="external me">Twitter</a>
    </ul>
  </footer>


  <script src="/static/javascripts/highlight.pack.js"></script>
  <script>
    // Syntax highlighting for code.
    hljs.tabReplace = '  ';
    hljs.initHighlightingOnLoad();
  </script>
  <script>
    // Google Analytics.
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-17930798-22', 'smus.com');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>
  <script src="//cdn.webglstats.com/stat.js" defer="defer" async="async"></script>
  <script src="/lightning_error.js"></script>
</body>