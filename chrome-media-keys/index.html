<!doctype html>
<head>
  <title>Chrome Media Keyboard Shortcuts | Boris Smus</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="

Few people want to synchronize their burgeoning music libraries across
computers (SSDs are small), or even lift it into the clouds with
something like Amazon's Music Cloud (uploading would take forever).">

  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="/static/icons/favicon.ico" />
  <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">

  <!-- Styles -->
  <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:700|PT+Sans|Inconsolata' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/static/stylesheets/screen.css" type="text/css" media="screen" charset="utf-8">

  <!-- Feed -->
  <link href="http://feeds.feedburner.com/smuscom" rel="alternate" title="Boris Smus" type="application/atom+xml"/>
</head>
<body>
  <header>
    <span class="left">
      <a href="/" class="name">Boris Smus</a>
    </span>
    <span class="right">
      <a href="/projects/">Projects</a>
      <a href="/about/">About</a>
      <a href="/archive/posts/">Archives</a>
    </span>
  </header>

  <div id="main">
    <section id="articles">
      
<article>
  <h1><a href="/chrome-media-keys">Chrome Media Keyboard Shortcuts</a></h1>
  <div class="subtitle">
  
  <time>Published on 01 April 2011</time>
  
  
  </div>
  <p>
    <p>Few people want to synchronize their burgeoning music libraries across
computers (SSDs are small), or even lift it into the clouds with
something like Amazon's Music Cloud (uploading would take forever). As a
result many are saying goodbye to iTunes and moving to web-based
streaming music services like <a href="http://listen.grooveshark.com/">grooveshark</a>, <a href="http://www.last.fm">last.fm</a>,
<a href="http://thesixtyone.com">thesixtyone</a>, <a href="http://rdio.com">rd.io</a> etc. This move has a significant UX drawback:
many keyboards come with multimedia keys to control your music player,
but these are useless if you use a web-based music player. This post
addresses this inconvenience with <a href="https://chrome.google.com/extensions/detail/cpgegiegacijlefhjkfodppcefjhgdeo/">Media Keys</a>, a Chrome extension
that lets you assign keyboard shortcuts in Chrome control web-based
music players (currently thesixtyone only).</p>

<h2>How it works</h2>

<p>The extension relies on two injected <a href="http://code.google.com/chrome/extensions/content_scripts.html">content scripts</a>: <a href="https://github.com/borismus/Chrome-Media-Keys/blob/master/key.js">key.js</a>, a
keyboard event listener injected into all pages and <a href="https://github.com/borismus/Chrome-Media-Keys/blob/master/t61.js">player.js</a>, a
music player controller, injected into the player page. </p>

<p>Key.js intercepts keyboard commands (ex. the next song key), and if they
match bound music player keyboard shortcuts (ex. next song key =>
change to the next song), it sends a message to player.js, which then
does the right thing (ex. changes to the next song) by simulating mouse
clicks.  Sounds good on paper, but the snag here is that you can't
easily do direct tab-to-tab communication in Chrome extensions, except
possibly through a long-lived port connection. However using long lived
connections doesn't make conceptual sense, since the lifespan of a tab
is relatively short. </p>

<p>So we go the long way with the help of a <a href="http://code.google.com/chrome/extensions/background_pages.html">background page</a>.</p>

<ol>
<li>On tab load, injected key.js messages the background page to
retrieve media key bindings</li>
<li>On music player load, injected player.js messages the background
page, reporting its tab ID. The background page <a href="http://code.google.com/chrome/extensions/messaging.html#connect">opens a Port</a>
through which to communicate with the player page</li>
<li>Matching keyboard events on all tabs send messages to the background
page. The background page then relays those messages through the
port to the music player</li>
</ol>

<p>Here's an abridged code sample from the <a href="https://github.com/borismus/Chrome-Media-Keys/blob/master/dispatch.html">background page</a>: </p>

<pre><code>chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
    switch(request.type) {
      case 'command':
        try {
          port.postMessage(request.command);
        } catch(error) {
          if (localStorage['autoload']) {
            chrome.tabs.create({url: SITE_URL});
          }
        }
        sendResponse({});
        break;
      case 'register':
        chrome.tabs.getSelected(null, function(tab) {
          port = chrome.tabs.connect(tab.id);
          sendResponse({});
        });
        break;
    }
  }
);
</code></pre>

<p>To summarize, this approach enables a client-side remote control for a
specific web application from any other page. This is potent stuff!</p>

<h2>Try it out</h2>

<p>Want to try it out? Media Keys works across all Chrome platforms.</p>

<ol>
<li>Install <a href="http://kevingessner.com/software/functionflip/">Function Flip</a> <em>(Mac only)</em></li>
<li>Check previous, pause/play and next buttons (F6, F7, F8 here) <em>(Mac
only)</em></li>
<li>Install the <a href="https://chrome.google.com/extensions/detail/cpgegiegacijlefhjkfodppcefjhgdeo">Media Keys</a> extension</li>
<li>Open up the extension options, bind the keys and save</li>
<li>Open up a new page and press the key bound to play</li>
</ol>

<p>I made a short screencast showing how to install configure and use the
extension.</p>

<iframe title="YouTube video player" width="600" height="368"
  src="http://www.youtube.com/embed/SrfsnU2gSyI" frameborder="0"
  allowfullscreen></iframe>

<h2>Wish list</h2>

<p>Just to recap, the keyboard shortcut binding pattern described above
injects a script into all tabs, which essentially listens to all key
events. A malicious developer could write a key logger watches username
and password fields, correlates to the current domain and sends
harvested data to some private server. </p>

<p>There are also several limitations to this keyboard shortcut binding
pattern. It simply won't work in the following cases:</p>

<ol>
<li>Chrome is in the background</li>
<li>Focus inside chrome is not on the page (ex. location bar)</li>
<li>Chrome is on a special page (ex. new tab page) where content scripts
don't get injected</li>
<li>The current page intercepts keyboard events and stops propagation
(ex. Google Docs)</li>
</ol>

<p>Keyboard shortcuts are super important to power users, and Chrome (OS)
surely won't leave us in the dust, so I'm looking forward to helping
address the security risks and practical limitations this approach as a
Chromium project contributor.</p>

<h2>Share and enjoy</h2>

<p>One last thing. If you've read my <a href="/chrome-extension-mashups/">previous post</a>, you know that I'm a
big fan of <a href="http://thesixtyone.com">thesixtyone.com</a> so my initial implementation
works for this service only. Making it work for other music streaming
services is just a matter of creating a customized player.js file for
your favorite music app, and tweaking the manifest to inject the new
player.js into the correct domain. Feel free to fork the 
<a href="https://github.com/borismus/Chrome-Media-Keys">project on github</a>.</p>

  </p>

  <!--
  DISABLED COMMENTS.

  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'smus'; // Required - Replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
  -->
</article>

    </section>
    <aside>
      <img src="/static/images/me.jpg" alt="Headshot of Author" title="Headshot of Author">
      <p>
        I'm Boris Smus, a software engineer and UI prototyper from
        Vancouver, Canada. I currently live in San Francisco and work on
        Chrome related things.
        <a href="/about/" class="readmore"></a>
      </p>
    </aside>
  </div>

  <div id="push"></div>

  <footer>
    <p>
      &copy; 2008 - 2015 Boris Smus<br>
      Powered by <a href="/site/">Lightning</a>
    </p>

    <ul id="social-links">
      <a href="http://feeds.feedburner.com/smuscom" class="social rss" title="RSS" rel="external me">RSS</a>
      <a href="https://github.com/borismus" class="social github" title="GitHub" rel="external me">GitHub</a>
      <a href="https://profiles.google.com/boris.smus" rel="author" class="social plus" title="Google Plus" rel="external me">Google Plus</a>
      <a href="https://twitter.com/borismus" class="social twitter" title="Twitter" rel="external me">Twitter</a>
    </ul>
  </footer>


  <script src="/static/javascripts/highlight.pack.js"></script>
  <script>
    // Syntax highlighting for code.
    hljs.tabReplace = '  ';
    hljs.initHighlightingOnLoad();
  </script>
  <script>
    // Google Analytics.
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-17930798-22', 'smus.com');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>
  <script src="//cdn.webglstats.com/stat.js" defer="defer" async="async"></script>
  <script src="/lightning_error.js"></script>
</body>